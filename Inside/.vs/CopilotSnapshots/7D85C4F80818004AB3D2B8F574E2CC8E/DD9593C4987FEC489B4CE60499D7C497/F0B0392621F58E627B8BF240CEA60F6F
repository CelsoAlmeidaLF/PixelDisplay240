<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - PixelStream IDE</title>
    <link rel="stylesheet" href="~/css/style.css" asp-append-version="true">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="theme-default">
    <!-- Traditional Loading Screen -->
    <div id="app-loading-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#0f172a;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-family:'Outfit',sans-serif;">
        <div class="loader-spinner" style="width:40px;height:40px;border:4px solid rgba(255,255,255,0.1);border-top:4px solid #38bdf8;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px;"></div>
        <h2 style="font-weight:600;margin:0;">PixelStream IDE</h2>
        <p id="loading-status" style="font-size:0.8rem;opacity:0.7;margin-top:10px;">Carregando recursos...</p>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <div class="app-container" style="opacity:0;transition:opacity 0.5s ease;">
        @RenderBody()
    </div>

    <!-- Scripts with onload validation -->
    <script src="~/js/prototype/model.js?v=@DateTime.Now.Ticks" onload="markLoaded('model.js')" onerror="markError('model.js')"></script>
    <script src="~/js/prototype/stage-manager.js?v=@DateTime.Now.Ticks" onload="markLoaded('stage-manager.js')" onerror="markError('stage-manager.js')"></script>
    <script src="~/js/prototype/tft-commands.js?v=@DateTime.Now.Ticks" onload="markLoaded('tft-commands.js')" onerror="markError('tft-commands.js')"></script>
    <script src="~/js/prototype/view.js?v=@DateTime.Now.Ticks" onload="markLoaded('view.js')" onerror="markError('view.js')"></script>
    <script src="~/js/prototype/controller.js?v=@DateTime.Now.Ticks" onload="markLoaded('controller.js')" onerror="markError('controller.js')"></script>
    
    <script src="~/js/designer.js?v=@DateTime.Now.Ticks" onload="markLoaded('designer.js')" onerror="markError('designer.js')"></script>
    <script src="~/js/script.js?v=@DateTime.Now.Ticks" onload="markLoaded('script.js')" onerror="markError('script.js')"></script>

    <script>
        const requiredScripts = ['model.js', 'stage-manager.js', 'tft-commands.js', 'view.js', 'controller.js', 'designer.js', 'script.js'];
        const loadedScripts = new Set();
        const statusEl = document.getElementById('loading-status');
        const overlay = document.getElementById('app-loading-overlay');
        const container = document.querySelector('.app-container');

        function markLoaded(scriptName) {
            loadedScripts.add(scriptName);
            // console.log('Loaded:', scriptName);
            if (statusEl) statusEl.textContent = `Carregando... (${loadedScripts.size}/${requiredScripts.length})`;
            checkAllLoaded();
        }

        function markError(scriptName) {
            if (statusEl) {
                statusEl.innerHTML = `<span style="color:#ef4444">Erro ao carregar: ${scriptName}</span><br>Verifique o console (F12).`;
                statusEl.style.opacity = 1;
            }
            console.error('Failed to load resource:', scriptName);
        }

        function checkAllLoaded() {
            if (loadedScripts.size === requiredScripts.length) {
                if (statusEl) statusEl.textContent = 'Inicializando...';
                
                // Give a small buffer for script execution (app.start)
                setTimeout(() => {
                    overlay.style.opacity = '0';
                    overlay.style.pointerEvents = 'none';
                    container.style.opacity = '1';
                    // Remove from DOM after fade out
                    setTimeout(() => overlay.remove(), 500);
                }, 500);
            }
        }
        
        // Failsafe timeout 
        setTimeout(() => {
            if (loadedScripts.size !== requiredScripts.length) {
                const missing = requiredScripts.filter(s => !loadedScripts.has(s));
                if(statusEl) statusEl.innerHTML = `Tempo limite excedido.<br>Faltando: ${missing.join(', ')}`;
            }
        }, 10000); // 10 seconds timeout
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
